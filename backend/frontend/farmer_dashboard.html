<!-- backend/frontend/farmer_dashboard.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Farmer Dashboard â€” AGROLINK-AI</title>
<style>
  :root{--green:#1b8a28;--muted:#527f52}
  body{margin:0;background:#eaf8ea;font-family:Segoe UI,Arial}
  header{background:var(--green);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
  header h1{margin:0;font-size:18px}
  .logout{background:#fff;color:var(--green);border:none;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .wrap{padding:18px;max-width:1100px;margin:auto}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:14px}
  .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
  .title{font-weight:700;color:var(--green)}
  .value{font-size:24px;font-weight:800;margin-top:8px}
  .muted{color:var(--muted);font-size:14px;margin-top:8px}
  .controls { display:flex; gap:8px; align-items:center; }
  .lang { padding:6px 8px; border-radius:8px; border:1px solid #c9e8c2; }
  .mic { background:#fff; border:2px solid var(--green); color:var(--green); padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; }
  .btn { padding:8px; border-radius:8px; border:none; background:var(--green); color:#fff; cursor:pointer; font-weight:700; }
  .small { font-size:13px; }
  .product-list .prod { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; padding:8px; border-radius:8px; background:#f6fff6; }
  .danger { background:#ff4d4f; color:white; padding:6px 8px; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>
<header>
  <h1 data-i18n="heading">ğŸ‘¨â€ğŸŒ¾ Farmer Dashboard</h1>
  <div class="controls">
    <select id="langSelect" class="lang small" title="Language">
      <option value="en-IN">English</option>
      <option value="hi-IN">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
    </select>
    <button id="micBtn" class="mic small">ğŸ¤</button>
    <button id="logoutBtn" class="logout small" data-i18n="logout">Logout</button>
  </div>
</header>

<div class="wrap">
  <h2 data-i18n="liveSensors">ğŸ“¡ Live Sensor Data</h2>
  <div class="grid">
    <div class="card"><div class="title" data-i18n="moisture">Moisture</div><div id="moist" class="value">--</div><div class="muted" id="moistHint"></div></div>
    <div class="card"><div class="title" data-i18n="temp">Temperature</div><div id="temp" class="value">--</div><div class="muted" id="tempHint"></div></div>
    <div class="card"><div class="title" data-i18n="humidity">Humidity</div><div id="humidity" class="value">--</div></div>
    <div class="card"><div class="title" data-i18n="ph">pH Level</div><div id="ph" class="value">--</div></div>
    <div class="card"><div class="title" data-i18n="npk">NPK</div><div id="npk" class="value">--</div></div>
  </div>

  <h2 style="margin-top:18px;" data-i18n="aiInsights">ğŸŒ¿ AI Insights</h2>
  <div class="grid">
    <div class="card"><div class="title" data-i18n="farmCondition">ğŸŒ± Farm Condition</div><div id="farmCondition" class="value">--</div><div id="farmHint" class="muted"></div></div>
    <div class="card"><div class="title" data-i18n="yield">ğŸ“ˆ Yield Prediction</div><div id="yieldValue" class="value">--</div><button class="btn" onclick="predictYield()" data-i18n="predictYieldBtn">Predict Yield</button></div>
    <div class="card"><div class="title" data-i18n="pricePred">ğŸ’° Price Prediction</div><div id="priceValue" class="value">--</div><button class="btn" onclick="predictPrice()" data-i18n="predictPriceBtn">Predict Price</button></div>
    <div class="card"><div class="title" data-i18n="fertilizer">ğŸ§ª Fertilizer Suggestion</div><div id="fertValue" class="muted">--</div><button class="btn" onclick="predictFertilizer()" data-i18n="fertBtn">Get Suggestion</button></div>
  </div>

  <h2 style="margin-top:18px;" data-i18n="quality">ğŸ–¼ Produce Quality Check</h2>
  <div class="card">
    <input type="file" id="produceImage" accept="image/*" />
    <button class="btn" onclick="checkQuality()" data-i18n="checkQualityBtn">Check Produce Quality</button>
    <div id="qualityResult" class="muted"></div>
  </div>

  <h2 style="margin-top:18px;" data-i18n="sellSection">ğŸ“¦ Your Listed Products</h2>
  <div class="card product-list" id="productList">
    <div class="muted small" id="noProducts" data-i18n="noProducts">Loading products...</div>
  </div>

  <div style="margin-top:18px">
    <button class="btn" onclick="openSellPage()" data-i18n="goSell">Go to Sell Produce â†’</button>
  </div>
</div>

<script>
/* =========================
   Configuration & helpers
   ========================= */
const API = location.origin + '/api';
const token = JSON.parse(localStorage.getItem('agro_user') || '{}').token || null;
const user = JSON.parse(localStorage.getItem('agro_user') || '{}');

if (!user || user.role !== 'farmer') {
  location.href = 'login.html';
}

// translations (expandable)
const DICT = {
  "en-IN": {
    heading: "ğŸ‘¨â€ğŸŒ¾ Farmer Dashboard",
    logout: "Logout",
    liveSensors: "ğŸ“¡ Live Sensor Data",
    moisture: "Moisture",
    temp: "Temperature",
    humidity: "Humidity",
    ph: "pH Level",
    npk: "NPK",
    aiInsights: "ğŸŒ¿ AI Insights",
    farmCondition: "ğŸŒ± Farm Condition",
    yield: "ğŸ“ˆ Yield Prediction",
    predictYieldBtn: "Predict Yield",
    pricePred: "ğŸ’° Price Prediction",
    predictPriceBtn: "Predict Price",
    fertilizer: "ğŸ§ª Fertilizer Suggestion",
    fertBtn: "Get Suggestion",
    quality: "ğŸ–¼ Produce Quality Check",
    checkQualityBtn: "Check Produce Quality",
    sellSection: "ğŸ“¦ Your Listed Products",
    noProducts: "No products listed yet.",
    goSell: "Go to Sell Produce â†’",
    listenStart: "Listening...",
    listenStop: "Stopped listening",
    commandNotFound: "Command not recognized",
    deleted: "Deleted",
    deleteConfirm: "Are you sure you want to delete this product?"
  },
  "hi-IN": {
    heading: "ğŸ‘¨â€ğŸŒ¾ à¤•à¤¿à¤¸à¤¾à¤¨ à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡",
    logout: "à¤²à¥‰à¤— à¤†à¤‰à¤Ÿ",
    liveSensors: "ğŸ“¡ à¤²à¤¾à¤‡à¤µ à¤¸à¥‡à¤‚à¤¸à¤° à¤¡à¤¾à¤Ÿà¤¾",
    moisture: "à¤›à¤® (Moisture)",
    temp: "à¤¤à¤¾à¤ªà¤®à¤¾à¤¨",
    humidity: "à¤¨à¤®à¥€",
    ph: "à¤®à¤¿à¤Ÿà¥à¤Ÿà¥€ pH",
    npk: "NPK",
    aiInsights: "ğŸŒ¿ à¤à¤†à¤ˆ à¤‡à¤¨à¤¸à¤¾à¤‡à¤Ÿà¥à¤¸",
    farmCondition: "ğŸŒ± à¤–à¥‡à¤¤ à¤•à¥€ à¤¸à¥à¤¥à¤¿à¤¤à¤¿",
    yield: "ğŸ“ˆ à¤‰à¤ªà¤œ à¤ªà¥‚à¤°à¥à¤µà¤¾à¤¨à¥à¤®à¤¾à¤¨",
    predictYieldBtn: "à¤‰à¤ªà¤œ à¤…à¤¨à¥à¤®à¤¾à¤¨ à¤²à¤—à¤¾à¤à¤‚",
    pricePred: "ğŸ’° à¤•à¥€à¤®à¤¤ à¤…à¤¨à¥à¤®à¤¾à¤¨",
    predictPriceBtn: "à¤•à¥€à¤®à¤¤ à¤…à¤¨à¥à¤®à¤¾à¤¨à¤¿à¤¤ à¤•à¤°à¥‡à¤‚",
    fertilizer: "ğŸ§ª à¤‰à¤°à¥à¤µà¤°à¤• à¤¸à¥à¤à¤¾à¤µ",
    fertBtn: "à¤¸à¥à¤à¤¾à¤µ à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤•à¤°à¥‡à¤‚",
    quality: "ğŸ–¼ à¤‰à¤ªà¤œ à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾ à¤œà¤¾à¤à¤š",
    checkQualityBtn: "à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾ à¤œà¤¾à¤à¤šà¥‡à¤‚",
    sellSection: "ğŸ“¦ à¤†à¤ªà¤•à¥€ à¤²à¤¿à¤¸à¥à¤Ÿà¥‡à¤¡ à¤‰à¤¤à¥à¤ªà¤¾à¤¦",
    noProducts: "à¤…à¤¬ à¤¤à¤• à¤•à¥‹à¤ˆ à¤‰à¤¤à¥à¤ªà¤¾à¤¦ à¤¸à¥‚à¤šà¥€à¤¬à¤¦à¥à¤§ à¤¨à¤¹à¥€à¤‚ à¤¹à¥ˆà¥¤",
    goSell: "à¤¬à¥‡à¤šà¤¨à¥‡ à¤•à¥‡ à¤ªà¤¨à¥à¤¨à¥‡ à¤ªà¤° à¤œà¤¾à¤à¤ â†’",
    listenStart: "à¤¸à¥à¤¨ à¤°à¤¹à¤¾ à¤¹à¥ˆ...",
    listenStop: "à¤¸à¥à¤¨à¤¨à¤¾ à¤¬à¤‚à¤¦ à¤¹à¥à¤†",
    commandNotFound: "à¤•à¤®à¤¾à¤¨à¥à¥œ à¤¸à¤®à¤ à¤®à¥‡à¤‚ à¤¨à¤¹à¥€à¤‚ à¤†à¤¯à¤¾",
    deleted: "à¤¹à¤Ÿà¤¾à¤¯à¤¾ à¤—à¤¯à¤¾",
    deleteConfirm: "à¤•à¥à¤¯à¤¾ à¤†à¤ª à¤µà¤¾à¤•à¤ˆ à¤‡à¤¸ à¤‰à¤¤à¥à¤ªà¤¾à¤¦ à¤•à¥‹ à¤¹à¤Ÿà¤¾à¤¨à¤¾ à¤šà¤¾à¤¹à¤¤à¥‡ à¤¹à¥ˆà¤‚?"
  }
};

// helper for i18n
function applyTranslations(lang) {
  const dict = DICT[lang] || DICT['en-IN'];
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if (dict[key]) el.innerText = dict[key];
  });
  // set recognition language later
}

/* =========================
   Microphone / Speech
   ========================= */
let recognition = null;
let isListening = false;
const micBtn = document.getElementById('micBtn');
const langSelect = document.getElementById('langSelect');

function setupSpeech() {
  const WebSpeech = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!WebSpeech) {
    micBtn.style.display = 'none';
    return;
  }
  recognition = new WebSpeech();
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  setRecognitionLang(langSelect.value);

  recognition.onstart = () => {
    isListening = true;
    micBtn.innerText = 'ğŸ™ï¸';
    speak(DICT[langSelect.value].listenStart);
  };
  recognition.onend = () => {
    isListening = false;
    micBtn.innerText = 'ğŸ¤';
    speak(DICT[langSelect.value].listenStop);
  };
  recognition.onerror = (ev) => {
    console.error('Speech error', ev);
  };
  recognition.onresult = (ev) => {
    const text = ev.results[0][0].transcript.trim();
    handleVoiceCommand(text.toLowerCase(), langSelect.value);
  };
}

function setRecognitionLang(lang) {
  if (recognition) recognition.lang = lang;
  // also set TTS default
}

function toggleMic() {
  if (!recognition) return;
  if (isListening) recognition.stop();
  else recognition.start();
}

micBtn.addEventListener('click', toggleMic);
langSelect.addEventListener('change', () => {
  applyTranslations(langSelect.value);
  setRecognitionLang(langSelect.value);
});

/* TTS helper */
function speak(text) {
  try {
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = langSelect.value;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utter);
  } catch (e) { console.warn('TTS error', e); }
}

/* voice command matching sets (english + hindi example phrases) */
const COMMANDS = {
  "en-IN": {
    openSell: ['open sell produce', 'open sell', 'sell produce', 'open sell page', 'open sell produce page'],
    predictPrice: ['predict price', 'predict the price', 'price prediction'],
    checkQuality: ['check quality', 'check produce quality'],
    logout: ['logout', 'log out', 'sign out'],
    showSensors: ['show sensors', 'display sensors'],
    goToSell: ['go to sell produce', 'open sell produce']
  },
  "hi-IN": {
    openSell: ['à¤¬à¤¿à¤•à¥à¤°à¥€ à¤–à¥‹à¤²à¥‹', 'à¤¬à¥‡à¤šà¤¨à¥‡ à¤•à¤¾ à¤ªà¤¨à¥à¤¨à¤¾ à¤–à¥‹à¤²à¥‹', 'sell produce', 'à¤¸à¥‡à¤² à¤ªà¥‡à¤œ à¤–à¥‹à¤²à¥‹'],
    predictPrice: ['à¤•à¥€à¤®à¤¤ à¤¬à¤¤à¤¾à¤“', 'à¤•à¥€à¤®à¤¤ à¤•à¤¾ à¤…à¤¨à¥à¤®à¤¾à¤¨ à¤²à¤—à¤¾à¤“'],
    checkQuality: ['à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾ à¤œà¤¾à¤à¤šà¥‹', 'à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾ à¤¬à¤¤à¤¾à¤“'],
    logout: ['à¤²à¥‰à¤— à¤†à¤‰à¤Ÿ', 'à¤¬à¤¾à¤¹à¤° à¤¨à¤¿à¤•à¤²à¥‹', 'à¤¸à¤¾à¤‡à¤¨ à¤†à¤‰à¤Ÿ'],
    showSensors: ['à¤¸à¥‡à¤‚à¤¸à¤° à¤¦à¤¿à¤–à¤¾à¤“', 'à¤¸à¥‡à¤‚à¤¸à¤° à¤¦à¤¿à¤–à¤¾à¤à¤‚']
  }
};

function handleVoiceCommand(text, lang) {
  const cmds = COMMANDS[lang] || COMMANDS['en-IN'];

  // helper checkers
  const matches = (arr) => arr.some(a => text.includes(a));

  if (matches(cmds.openSell)) {
    speak(lang === 'hi-IN' ? 'à¤¬à¥‡à¤šà¤¨à¥‡ à¤•à¤¾ à¤ªà¤¨à¥à¤¨à¤¾ à¤–à¥‹à¤² à¤°à¤¹à¤¾ à¤¹à¥‚à¤' : 'Opening sell produce page');
    openSellPage();
    return;
  }
  if (matches(cmds.predictPrice)) {
    speak(lang === 'hi-IN' ? 'à¤•à¥€à¤®à¤¤ à¤…à¤¨à¥à¤®à¤¾à¤¨ à¤•à¤° à¤°à¤¹à¤¾ à¤¹à¥‚à¤' : 'Predicting price');
    predictPrice();
    return;
  }
  if (matches(cmds.checkQuality)) {
    speak(lang === 'hi-IN' ? 'à¤—à¥à¤£à¤µà¤¤à¥à¤¤à¤¾ à¤œà¤¾à¤à¤š à¤°à¤¹à¤¾ à¤¹à¥‚à¤' : 'Checking quality');
    checkQuality();
    return;
  }
  if (matches(cmds.logout)) {
    speak(lang === 'hi-IN' ? 'à¤²à¥‰à¤— à¤†à¤‰à¤Ÿ à¤•à¤° à¤°à¤¹à¤¾ à¤¹à¥‚à¤' : 'Logging out');
    logout();
    return;
  }
  if (matches(cmds.showSensors)) {
    speak(lang === 'hi-IN' ? 'à¤¸à¥‡à¤‚à¤¸à¤° à¤¦à¤¿à¤–à¤¾ à¤°à¤¹à¤¾ à¤¹à¥‚à¤' : 'Showing sensors');
    // maybe focus sensors
    document.getElementById('moist').scrollIntoView({behavior:'smooth'});
    return;
  }

  // fallback
  speak(DICT[lang].commandNotFound || 'Command not recognized');
}

/* =========================
   Frontend product list + delete
   ========================= */

async function loadProducts() {
  try {
    const res = await fetch(API + '/products/my', {
      headers: token ? { 'Authorization': 'Bearer ' + token } : {}
    });
    if (!res.ok) {
      // fallback to localStorage or show no products
      document.getElementById('noProducts').innerText = DICT[langSelect.value].noProducts;
      return;
    }
    const prods = await res.json();
    const container = document.getElementById('productList');
    container.innerHTML = '';
    if (!prods || prods.length === 0) {
      document.getElementById('noProducts').innerText = DICT[langSelect.value].noProducts;
      return;
    }

    prods.forEach(p => {
      const div = document.createElement('div');
      div.className = 'prod';
      div.innerHTML = `
        <div>
          <strong>${p.name}</strong><br>
          <span class="small">${p.qty} kg â€¢ â‚¹ ${p.price}/kg</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn small" onclick="editProduct('${p._id}')">Edit</button>
          <button class="danger small" onclick="deleteProduct('${p._id}','${p.name}')">Delete</button>
        </div>
      `;
      container.appendChild(div);
    });
  } catch (e) {
    console.error('loadProducts error', e);
    document.getElementById('noProducts').innerText = DICT[langSelect.value].noProducts;
  }
}

function openSellPage() {
  location.href = 'sell_produce.html';
}

function editProduct(id) {
  // placeholder â€” you can implement edit UI
  alert('Edit not implemented â€” implement separate form for product id: ' + id);
}

async function deleteProduct(id, name) {
  const confirmed = confirm(DICT[langSelect.value].deleteConfirm || 'Delete?');
  if (!confirmed) return;

  try {
    const res = await fetch(API + '/products/' + id, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) {
      const err = await res.json();
      alert(err.error || 'Delete failed');
      return;
    }
    speak((DICT[langSelect.value].deleted || 'Deleted') + ': ' + name);
    await loadProducts();
  } catch (e) {
    console.error('deleteProduct error', e);
    alert('Network error');
  }
}

/* =========================
   Dummy sensor + ML actions (kept from your previous code)
   ========================= */

let sensors = { temp:28, moisture:45, npk:380, ph:6.7 };

function updateSensorUI() {
  document.getElementById('temp').innerText = sensors.temp + 'Â°C';
  document.getElementById('moist').innerText = sensors.moisture + '%';
  document.getElementById('npk').innerText = sensors.npk;
  document.getElementById('ph').innerText = sensors.ph;
  // Farm condition
  let score=0;
  if (sensors.moisture>=35 && sensors.moisture<=55) score++;
  if (sensors.temp>=20 && sensors.temp<=32) score++;
  if (sensors.ph>=6 && sensors.ph<=7.5) score++;
  if (sensors.npk>=300 && sensors.npk<=600) score++;
  const status = score>=3 ? 'ğŸŸ¢ GOOD' : score===2 ? 'ğŸŸ¡ MODERATE' : 'ğŸ”´ POOR';
  document.getElementById('farmCondition').innerText = status;
  document.getElementById('yieldValue').innerText = Math.round((sensors.moisture + sensors.temp + sensors.npk/10)/4) + '%';
  document.getElementById('fertValue').innerText = sensors.npk < 300 ? 'Add Nitrogen-rich fertilizer' : 'Balanced NPK recommended';
}

async function predictYield(){ speak('Predicting yield (simulated)'); /* call ML API if available */ }
async function predictPrice(){ const predicted = Math.round((sensors.temp*2 + sensors.moisture + sensors.npk/20 + sensors.ph*5)*1.1); document.getElementById('priceValue').innerText = 'â‚¹ ' + predicted; speak('Predicted price ' + predicted); }
async function predictFertilizer(){ speak('Getting suggestion (simulated)'); }
async function checkQuality(){ speak('Quality check (simulated)'); document.getElementById('qualityResult').innerText = 'Quality: HIGH (simulated)'; }

/* =========================
   Auth / Logout
   ========================= */
function logout() {
  localStorage.removeItem('agro_user');
  location.href = 'login.html';
}
document.getElementById('logoutBtn').addEventListener('click', logout);

/* =========================
   Init
   ========================= */
(function init(){
  // set language from storage or browser
  const savedLang = localStorage.getItem('agro_lang') || navigator.language || 'en-IN';
  if (!DICT[savedLang]) { langSelect.value = 'en-IN'; } else langSelect.value = savedLang;
  applyTranslations(langSelect.value);
  langSelect.addEventListener('change', () => {
    localStorage.setItem('agro_lang', langSelect.value);
    applyTranslations(langSelect.value);
  });

  setupSpeech();
  setRecognitionLang(langSelect.value);

  updateSensorUI();
  loadProducts();

  // refresh sensors periodically (simulate)
  setInterval(()=> {
    // small simulation
    sensors.temp = 20 + Math.round(Math.random()*12);
    sensors.moisture = 30 + Math.round(Math.random()*40);
    sensors.npk = 250 + Math.round(Math.random()*400);
    sensors.ph = (5.5 + Math.random()*2).toFixed(1);
    updateSensorUI();
  }, 6000);
})();
</script>
</body>
</html>
